# eip712-struct-array
Testing repo for debugging how to properly encode and hash a message that contains a struct array in accordance to EIP712 using Viem.

### Setup
Viem Setup
1. clone repo: `git clone https://github.com/0xFloop/eip712-struct-array.git`
2. cd into the viem folder: `cd eip712-struct-array/viemTest`
3. install dep: `npm install`
4. run viem script: `npm run start`
5. copy the hash that is console.logged out

Sol Setup \n
1. cd to root: `cd ../`
2. open `~/test/EIP712SigConsumer.t.sol` and paste the copied viem generated hash into the `viemGeneratedDigest` on line 15
3. run `forge test -v`

## Problem
I cannot seem to figure out how to properly hash a struct (`MainStruct` in the example) that contains a struct array within it (`SubStruct[]` in the example) so that it produces the same hash as that generated by Viem's `hashTypedData` function.
I have written out three different options below that I have tried. Thank you very very much for any help!

## EIP712SigConsumer.sol
This contract operates as a simple EIP712 sig consumer. It offers 3 different functions for hashing a `MainStruct`. 
### hashStructNonRecursiveArray(MainStruct)
This option does nothing to the `SubStruct[]` and is just a straight forward `hashStruct(MainStruct)`.

### hashStructRecursiveHashArray(MainStruct)
This option hashes the `SubStruct[]` in accordance to an old EIP712 forum thread recommendation [HERE]("https://ethereum-magicians.org/t/eip-712-eth-signtypeddata-as-a-standard-for-machine-verifiable-and-human-readable-typed-data-signing/397/27"). Essentially using `hashStruct` on all the indices of the `SubStruct[]` and then hashing them all together.

### hashStructHashArray(MainStruct)
This option just plainly encodes and hashes the `SubStruct[]` 


### isValidHash(MainStruct, ViemHash)
This function compares a hash `ViemHash` (of the parameter MainStruct) generate using viem to that which is generated by all 3 of the seperate hashing functions in the contract and checks if they match.

## EIP712SigConsumer.t.sol

### testSigGeneratedByViem()
This is the test to check your viem hash vs that generated in the contract. Just save the viem hash to the `viemGeneratedDigest` var on line 15 to test.

## /viemTest
This folder contains simple script for generating a EIP712 hash using viems hashTypedData

## Note
The eip712 domains in Viem and in the Sol both use static data for the comparison, namely the sepolia chainId and address(0xdead) for the verifyingContract
